## 持续集成指标和关键活动

---

### 持续集成流水线是核心

- 提交代码之后的一系列任务都要流水线完成
- 所有自动化执行的任务的反馈信息都从流水线获得

### 流水线基础设施保障

保证流水线随时有足够的构建节点可供使用，随时处于可以访问的状态。

+++ 

#### 信息透明

- 团队所有成员都应该

#### 资源投入

- 流水线 Master 磁盘空间和内存分配足够
- 有足够的构建节点处于可用的状态
- 建立电子看板提供第一时间的信息反馈
- 建立文件（交付件、包）服务器减轻 Master 的存储负担

+++ 

#### 定期维护

- 定期（每周末）清理早期的构建记录和结果（文件或数据库）
- 定期对构建节点进行维护（磁盘空间清理、SDK安装/升级）
- 重要数据（流水线配置等）定期备份

#### Tips

尽可能使用虚拟化技术减轻构建节点维护的工作量

---

### 保障产品稳定地“集成”

维护一个或一系列“集成”脚本，保证产品在流水线上执行的任务有效稳定；做到即使不依靠流水线，新人也能自己简单地完成

#### 脚本编写和执行

- 选择框架和语言主流的构建或自动化工具（maven/gradle、F#、Makefile）
- 新模块加入时就应该准备好“构建”脚本
- 脚本内容不应该放在流水线的配置里，而是编写成通用（PS，shell）脚本
- 构建脚本具备一定的灵活性

#### Tips

**检验方法**: 任何人在任何符合条件（SDK已安装、网络已链接）的机器上，检出代码仓库中的代码，就可以使用仓库中包括的构建脚本完成流水线能完成的一切任务。

---

### 制定合理可达的 CI 指标

利用 CI 各种反馈数据指导和改进开发中的实践活动

---

### 原则

- 更多关注指标的变化，而不是制定不现实的固定目标
- 影响指标的活动由团队自己承诺，并使用看板跟踪

---

### 流水线成功率

最近一周流水线执行成功率达到 80 %（稳定性）

- 持续地执行（每天至少一次）
- 流水线有任何步骤失败就算失败
- 流水线即使增加验证步骤也要保证成功率

+++

#### 可能出现的问题

- 构建节点资源不够（构建过程耗费巨大的资源）
- 测试不稳定（依赖时间或线程、需要等待的测试）

+++

#### 解决方法

- 消耗资源的构建的专用节点
- 解除测试对时间/线程的依赖（使用Mock 或者 拆分逻辑）
- 使用“智能”（显式）等待，设置等待条件和足够的超时

---

### 流水线失败修复时间

流水线由“红”变“绿”的时间间隔应该在一小时内（响应速度）

- “红”不过夜

+++

#### Tips

- 使用电子看板（提示声音）更快的获得反馈（提示导致失败的提交记录）
- 为自己的问题负责，发现自己的提交导致建失败，应该停下手中的任务，优先修改构建失败
- 互相提醒和协助
- 短时间修补不了应该选择回滚代码

---

### 流水线执行时间

流水线完整执行时间不超过 30 分钟

---

#### 可能的问题

- 全量或顺序构建耗费时间
- 集成和功能测试耗费时间（I/O、等待）

#### 解决方法

- 采用构建工具提供的增量和平行构建参数
- 使用固态硬盘
- 测试等待使用“智能”等待，减少等待时间
- 测试能分组并行在多个节点上执行
- 降低耗费时间的执行步骤的频率，拆分成独立的流水线

---

### 单元（自动化）测试

- 有效单元（自动化）测试数量持续增加
- 避免单元（自动化）测试数量突增突减

#### 推荐实践

- 把单元（自动化）测试作为完成标准的一部分，由自己承诺合理的范围
- 代码审查时要关注单元（自动化）测试的有效性（断言是否充分合理）
- 建立 Checklist 帮助判断单元（自动化）测试的切入点

---

### 代码覆盖率

- 每个类中的重要方法都应该有单元测试覆盖
- 代码覆盖率整体变化趋势是先上升，到了某个拐点（经验值：40% 或 60%）变得平缓

+++

#### 推荐实践

- 在 IDE 中或本地运行单元测试时同时生成覆盖率报告，及时分析
- 重点关注覆盖率低的类，分析是否有代码需要测试覆盖
- 建立 Checklist 帮助判断单元（自动化）测试的切入点

---

### 例：单元（自动化）测试切入点 Checklist

- 冒烟测试（功能测试）
- 外部（暴露给其他模块的）公有接口（接口测试）
- 内部公有接口
- 嵌套（两层以上）if 和 switch
- 复杂计算逻辑
- 重构提取重复代码时
- 多处调用的方法
- 界面不用单元测试
- 属性（无副作用）不用单元测试

### Lint（静态代码问题）扫描结果

扫描发现“严重”级别以上的代码问题应该导致流水线失败。

+++

#### 推荐实践

- 开启 IDE 中的代码分析插件或功能，在提交之前发现并修正问题

--- 

### 复杂度和重复率

- 不允许出现复杂度超过 60 的类/文件
- 不允许重复出现 3 次的 10 行以上代码

+++

#### 推荐实践

- 代码审查时关注坏味道
- 避免嵌套 if 和 switch
- 将大方法分解为小方法并增加单元测试
- 将大类拆分成小类，并在大类中使用委托
- 开启 IDE 中的代码分析插件或功能，在提交之前发现重复
- 避免复制粘贴
- 对重复代码提取时增加单元测试

### 循环依赖

严禁代码中出现（库、模块、类各个级别的）循环依赖

